<!DOCTYPE html>
<html>
<head>
    <title>Form Test - Attendance Portal</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        form { background: #f8f9fa; padding: 20px; border-radius: 5px; margin: 20px 0; }
        input, select { width: 100%; padding: 8px; margin: 5px 0; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>üß™ Student Registration Form Test</h1>
    
    <div id="status" class="status info">
        <strong>System Status:</strong> <span id="systemStatus">Checking...</span>
    </div>

    <h2>Quick Registration Test</h2>
    <form id="testForm">
        <label>First Name: <input type="text" name="firstName" value="Test" required></label>
        <label>Last Name: <input type="text" name="lastName" value="Student" required></label>
        <label>Class: <select name="class" required>
            <option value="">Select Class</option>
            <option value="10" selected>10th Grade</option>
            <option value="11">11th Grade</option>
            <option value="12">12th Grade</option>
        </select></label>
        <label>Division: <select name="division" required>
            <option value="">Select Division</option>
            <option value="A" selected>A</option>
            <option value="B">B</option>
            <option value="C">C</option>
        </select></label>
        <label>Parent Mobile: <input type="tel" name="parent_mobile" value="9876543210" required></label>
        <label>Email: <input type="email" name="email" value="test@example.com"></label>
        <button type="submit">Register Student</button>
    </form>

    <div id="result"></div>

    <h2>Current Students</h2>
    <div id="studentsList">Loading...</div>
    <button onclick="loadStudents()">Refresh List</button>

    <h2>System Information</h2>
    <div id="systemInfo">Loading...</div>

    <script>
        // Check system status
        async function checkStatus() {
            try {
                const response = await fetch('/health');
                const data = await response.json();
                document.getElementById('systemStatus').innerHTML = 
                    `${data.status} | Storage: ${data.storage} | DB: ${data.database}`;
                
                if (data.memory_stats) {
                    document.getElementById('systemInfo').innerHTML = `
                        <strong>Memory Storage Stats:</strong><br>
                        Students: ${data.memory_stats.students}<br>
                        Attendance Records: ${data.memory_stats.attendance_records}<br>
                        Storage Type: ${data.memory_stats.storage_type}
                    `;
                }
            } catch (error) {
                document.getElementById('systemStatus').textContent = 'Error: ' + error.message;
            }
        }

        // Load students
        async function loadStudents() {
            try {
                const response = await fetch('/api/students');
                const data = await response.json();
                
                if (data.students && data.students.length > 0) {
                    document.getElementById('studentsList').innerHTML = 
                        '<strong>Total: ' + data.total + ' students</strong><br>' +
                        data.students.map(s => 
                            `‚Ä¢ ${s.name} (${s.student_id}) - Class ${s.class}${s.division || ''}`
                        ).join('<br>');
                } else {
                    document.getElementById('studentsList').innerHTML = 
                        '<em>No students found</em>';
                }
            } catch (error) {
                document.getElementById('studentsList').innerHTML = 
                    '<span style="color: red;">Error: ' + error.message + '</span>';
            }
        }

        // Handle form submission
        document.getElementById('testForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="status info">Submitting...</div>';
            
            const formData = new FormData(this);
            const studentData = Object.fromEntries(formData.entries());
            
            console.log('Submitting:', studentData);
            
            try {
                const response = await fetch('/add-student', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(studentData)
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (response.ok) {
                    const result = await response.text();
                    resultDiv.innerHTML = '<div class="status success">‚úÖ Student registered successfully!</div>';
                    loadStudents(); // Refresh the list
                } else {
                    const errorText = await response.text();
                    resultDiv.innerHTML = `<div class="status error">‚ùå Error ${response.status}: ${errorText}</div>`;
                }
            } catch (error) {
                console.error('Error:', error);
                resultDiv.innerHTML = `<div class="status error">‚ùå Network Error: ${error.message}</div>`;
            }
        });

        // Initialize
        checkStatus();
        loadStudents();
    </script>
</body>
</html>